<!DOCTYPE html>
<html lang="en">

<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
     <meta http-equiv="X-UA-Compatible" content="ie=edge">
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
     <link rel="stylesheet" href="../assets/css/style.css" />
     <style>
          
     </style>
</head>

<body>
          <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <a class="navbar-brand" href="#">Marvel Fight Night</a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                      <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                      <div class="navbar-nav">
                        <a class="nav-item nav-link active" href="/">Home <span class="sr-only">(current)</span></a>
                        <a class="nav-item nav-link" href="/addhero">Add Fighter</a>
                        <a class="nav-item nav-link" href="/pickAFight">Pick a Fight</a>
                      </div>
                    </div>
                  </nav>
     <div class="container my-2 ">
          
          <div class="row col-11 mx-auto bg-primary p-5">
               <h3 class="text-white">Choose your identity</h3>
               <select class="form-control" id="cboxhero">
                    <option value="0"></option>
               </select>
               <div class="form-check my-2 w-100">
                    <input class="form-check-input" type="checkbox" id="chkFightAny">
                    <label class="form-check-label" for="chkFightAny">
                         Find closest match regardless of allegiance
                    </label>
               </div>
               <p style="color:white;">After you click the Find Opponent button, you will be shown a list of most suitable opponents that closely match your skill. Scroll over each chart to see the exact skill. Click on the character to choose them as an opponent. </p>
               <div class="my-2">
                    <button id="btnSubmit" type="submit" class="btn btn-light">Find Opponent</button>
               </div>
          </div>
     </div>
     <div class="container my-2 d-flex justify-content-around">
          <div class="col col-5 my-2 p-3">
               <div class="charts player1 hidden">
                    <div class="dur" id="dur1"></div>
                    <div class="dur" id="energy1"></div>
                    <div class="dur" id="fight1"></div>
                    <div class="dur" id="intel1"></div>
                    <div class="dur" id="speed1"></div>
                    <div class="dur" id="str1"></div>
                    <div class="dur" id="gizmo1"></div>
               </div>
               <div class="my-2 charScreen hidden">
                    <p>
                         <strong>Real Name:</strong> <span class="labName"></span>
                    </p>
                    <p>
                         <img class="playerImg" src="" />
                    </p>
               </div>
          </div>
          <div class="col col-5 my-2 p-3">
               <div class="charts player2 hidden">
                    <div class="dur" id="dur2"></div>
                    <div class="dur" id="energy2"></div>
                    <div class="dur" id="fight2"></div>
                    <div class="dur" id="intel2"></div>
                    <div class="dur" id="speed2"></div>
                    <div class="dur" id="str2"></div>
                    <div class="dur" id="gizmo2"></div>

               </div>
               <div class="my-2 charScreen2 hidden">
                    <p><strong>Real Name:</strong> <span class="labName2"></span></p>
                    <p><img class="playerImg2" src="" /></p>
               </div>
               <div class="my-2 multiple2 hidden"></div>
          </div>
     </div>
     <script src='https://code.jquery.com/jquery-3.3.1.min.js'
          integrity='sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=' crossorigin='anonymous'></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
          integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
          crossorigin="anonymous"></script>
     <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
          integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
          crossorigin="anonymous"></script>
     <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
     <script src="https://d3js.org/d3.v4.min.js"></script>
     <script>
          let charArray = [];
          google.charts.load('current', { 'packages': ['corechart'] });

          $(document).ready(function () {
               let getUrl = "/api/getHeroes";
               $.ajax({
                    url: getUrl,
                    method: "GET"
               }).then(function (response) {
                    let cntr = 1;
                    charArray = response;
                    charArray.forEach(element => {
                         let anOpt = $("<option>");
                         anOpt.val(cntr);
                         anOpt.text(element.alias)
                         cntr++;
                         $("#cboxhero").append(anOpt);
                    });
               });

               $(".col").eq(1).mouseover(function () {
                    $(".player1").removeClass("hidden");
                    if($(".multiple2").hasClass("hidden")){
                         $(".player2").removeClass("hidden");
                    }
               })
               $(".col").eq(1).mouseout(function () {
                    $(".player1").addClass("hidden");
                    if($(".multiple2").hasClass("hidden")){
                         $(".player2").addClass("hidden");
                    }
               })
          });

          $("#cboxhero").on("change", function (evt) {
               if (this.value == "0") {
                    $(".charScreen").addClass("hidden");
                    return;
               }
               let char = charArray.find(o => {
                    return o.alias == $("#cboxhero option:selected").text()
               });
               $(".multiple2").addClass("hidden");
               $(".labName").text(char.name);
               $(".playerImg").attr("src", "");
               $(".playerImg").attr("src", char.img);
               $(".charScreen").removeClass("hidden");
               $(".charScreen2").addClass("hidden");
          })

          $("#btnSubmit").on("click", function () {
               let colWidth = $(".col").width();

               let getUrl = `/api/getOpponents/${$("#cboxhero option:selected").text()}&${$(".labName").text()}&${$("#chkFightAny").is(':checked')}`;
               $.ajax({
                    url: getUrl,
                    method: "GET"
               }).then(function (response) {
                    $(".playerImg2").attr("src", "");                    
                    $(".multiple2").html("");
                    $(".multiple2").removeClass("hidden");
                    $(".charScreen2").addClass("hidden");
                    popCharts(response.char, $(".player1"));
                    response.list.forEach(o => {
                         let charHolder = $("<div class='charHolder'>");
                         charHolder.data("char", o.name); 
                         charHolder.append(`<p>${o.alias}</p>`);
                         let parts = Object.keys(o.skill);
                         let openDiv = $("<div class='smallPieHolder'>");
                         parts.forEach((sk, i) => {
                              let charts = drawChart(sk, i, o.skill);
                              openDiv.append(charts)
                         })
                    charHolder.append(openDiv);
                    $(".multiple2").append(charHolder);
                    });

               });
          });

          function drawChart(skill, ind, allSkill) {

               function defaultColors(n) {
               let colores_g = ["#ff0000", "#ffffff"];
                    return colores_g[n % colores_g.length];
               }


               let aDiv = $("<div>");
               aDiv.width(($(".col").width()-80)/7)
               let data;
               if(skill == "gizmos"){
                    data = [
                         { name: "", value: 6 - allSkill[skill] },
                         { name: "", value: allSkill[skill] }
                    ];
               }else{
                    data = [
                         { name: "", value: allSkill[skill] },
                         { name: "", value: 7 - allSkill[skill] }
                    ];
               }

               let width = aDiv.width();
               let height = aDiv.width() + 30;
               let thickness = aDiv.width()*.3;


               let radius = aDiv.width() / 2;
               let color = defaultColors;

               let svg = d3.select(aDiv[0])
                    .append('svg')
                    .attr('class', 'pie')
                    .attr('width', width)
                    .attr('height', height);

               let g = svg.append('g')
                    .attr('transform', 'translate(' + (width / 2) + ',' + ((height-30) / 2) + ')');

               let arc = d3.arc()
                    .innerRadius(radius - thickness)
                    .outerRadius(radius);

               let pie = d3.pie()
                    .value(function (d) { return d.value; })
                    .sort(null);

               let path = g.selectAll('path')
                    .data(pie(data))
                    .enter()
                    .append("g")
                    .append('path')
                    .attr('d', arc)
                    .attr('fill', (d, i) => color(i))
                    .style("stroke", "#ccc")
                    .each(function (d, i) { this._current = i; });
               aDiv.attr('title', getCatName(skill))
               return aDiv;
          } 

          function getCatName(arg){
               let ret = "";
               switch(arg){
                    case "durability":
                         ret ="Durability"; 
                         break;
                    case "energy":
                         ret ="Energy"; 
                         break;
                    case "fighting":
                         ret ="Combat Skills"; 
                         break;
                    case "intel":
                    ret ="Intelligence"; 
                         break;
                    case "speed":
                    ret ="Speed"; 
                         break;
                    case "strength":
                    ret ="Strength"; 
                         break;
                    case "gizmos":
                    ret ="Gadget Reliance"; 
                         break;
                    default:
                         break;
               }
               return ret;
          }

          function popCharts(player, cont, isOpp = false) {
               let durHlder = $(cont).find(".dur");
               let colWidth = $(".col").width() / 2;
               let options = {
                    title: 'Durability',
                    pieHole: 0.4,
                    pieSliceText: 'none',
                    fontSize: "16",
                    legend: 'none',
                    slices: {
                         0: { color: isOpp ? '#ff0000' : '#3366cc' },
                         1: { color: 'transparent' }
                    },
                    pieSliceBorderColor: "#ccc",
                    width: colWidth,
                    height: 144,
                    'tooltip' : {
                    trigger: 'none'
                    }

               };
               let data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['', parseInt(player.skill.durability)],
                    ['', 7 - parseInt(player.skill.durability)],
               ]);
               let str = isOpp == true ? "dur2" : "dur1"
               let chart = new google.visualization.PieChart(document.getElementById(str));
               chart.draw(data, options);

               options = {
                    title: 'Energy',
                    fontSize: "16",
                    pieHole: 0.4,
                    pieSliceText: 'none',
                    legend: 'none',
                    slices: {
                         0: { color: isOpp ? '#ff0000' : '#3366cc' },
                         1: { color: 'transparent' }
                    },
                    pieSliceBorderColor: "#ccc", 
                    width: colWidth,
                    height: 144,
                    'tooltip' : {
                    trigger: 'none'
                    }
               }
               data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['', parseInt(player.skill.energy)],
                    ['', 7 - parseInt(player.skill.energy)],
               ]);
               str = isOpp == true ? "energy2" : "energy1";
               chart = new google.visualization.PieChart(document.getElementById(str));
               chart.draw(data, options);

               options = {
                    title: 'Combat Skills',
                    fontSize: "16",
                    pieHole: 0.4,
                    pieSliceText: 'none',
                    legend: 'none',
                    slices: {
                         0: { color: isOpp ? '#ff0000' : '#3366cc' },
                         1: { color: 'transparent' }
                    },
                    pieSliceBorderColor: "#ccc", 
                    width: colWidth,
                    height: 144,
                    'tooltip' : {
                    trigger: 'none'
                    }
               }
               data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['', parseInt(player.skill.fighting)],
                    ['', 7 - parseInt(player.skill.fighting)],
               ]);
               str = isOpp == true ? "fight2" : "fight1";
               chart = new google.visualization.PieChart(document.getElementById(str));
               chart.draw(data, options);

               options = {
                    title: 'Intelligence',
                    fontSize: "16",
                    pieHole: 0.4,
                    pieSliceText: 'none',
                    legend: 'none',
                    slices: {
                         0: { color: isOpp ? '#ff0000' : '#3366cc' },
                         1: { color: 'transparent' }
                    },
                    pieSliceBorderColor: "#ccc", 
                    width: colWidth,
                    height: 144,
                    'tooltip' : {
                    trigger: 'none'
                    }
               }
               data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['', parseInt(player.skill.intel)],
                    ['', 7 - parseInt(player.skill.intel)],
               ]);
               str = isOpp == true ? "intel2" : "intel1";
               chart = new google.visualization.PieChart(document.getElementById(str));
               chart.draw(data, options);

               options = {
                    title: 'Speed',
                    fontSize: "16",
                    pieHole: 0.4,
                    pieSliceText: 'none',
                    legend: 'none',
                    slices: {
                         0: { color: isOpp ? '#ff0000' : '#3366cc' },
                         1: { color: 'transparent' }
                    },
                    pieSliceBorderColor: "#ccc", 
                    width: colWidth,
                    height: 144,
                    'tooltip' : {
                    trigger: 'none'
                    }
               }
               data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['', parseInt(player.skill.speed)],
                    ['', 7 - parseInt(player.skill.speed)],
               ]);
               str = isOpp == true ? "speed2" : "speed1";
               chart = new google.visualization.PieChart(document.getElementById(str));
               chart.draw(data, options);

               options = {
                    title: 'Strength',
                    fontSize: "16",
                    pieHole: 0.4,
                    pieSliceText: 'none',
                    legend: 'none',
                    slices: {
                         0: { color: isOpp ? '#ff0000' : '#3366cc' },
                         1: { color: 'transparent' }
                    },
                    pieSliceBorderColor: "#ccc", 
                    width: colWidth,
                    height: 144,
                    'tooltip' : {
                    trigger: 'none'
                    }
               }
               data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['', parseInt(player.skill.strength)],
                    ['', 7 - parseInt(player.skill.strength)],
               ]);
               str = isOpp == true ? "str2" : "str1";
               chart = new google.visualization.PieChart(document.getElementById(str));
               chart.draw(data, options);

               options = {
                    title: 'Gadget Reliance',
                    fontSize: "16",
                    pieHole: 0.4,
                    pieSliceText: 'none',
                    legend: 'none',
                    slices: {
                         0: { color: isOpp ? '#ff0000' : '#3366cc' },
                         1: { color: 'transparent' }
                    },
                    pieSliceBorderColor: "#ccc", 
                    width: colWidth,
                    height: 144,
                    'tooltip' : {
                    trigger: 'none'
                    }
               }
               data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['', 6 - parseInt(player.skill.gizmos)],
                    ['', parseInt(player.skill.gizmos)],
               ]);
               str = isOpp == true ? "gizmo2" : "gizmo1";
               chart = new google.visualization.PieChart(document.getElementById(str));
               chart.draw(data, options);
          }
     
          $(document).on ("click", ".charHolder", function(evt){
               let getUrl = `/api/getOpponent/${$(this).data("char")}`;               
               $.ajax({
                    url: getUrl,
                    method: "GET"
               }).then(function (response) {
                    $(".labName2").text(response.char.name);
                    $(".charScreen2").removeClass("hidden");
                    $(".player2").remove("hidden");
                    $(".multiple2").addClass("hidden");
                    $(".playerImg2").attr("src",response.char.img);
                    popCharts(response.char, $(".player2"), true);
               });
          })
     </script>
</body>

</html>